@page "/agents/{AgentId}"
@using BlazorAIFoundryAgentsCatalog.Client.DTOs
@using BlazorAIFoundryAgentsCatalog.Client.Helpers
@using BlazorAIFoundryAgentsCatalog.Client.Services
@inherits FoundryAgentChatModel

<PageTitle>Agent Chat</PageTitle>

<MudPaper Class="pa-4" Elevation="0">
    @if (IsAgentInfoLoading)
    {
        <MudSkeleton Height="32px" Width="240px" Animation="Animation.Wave" Class="mb-2" />
        <MudSkeleton Height="20px" Width="80%" Animation="Animation.Wave" Class="mb-4" />
    }
    else
    {
        <MudText Typo="Typo.h5" GutterBottom="true">Chat with Agent @AgentName</MudText>
        @if (!string.IsNullOrWhiteSpace(AgentDescription))
        {
            <MudText Typo="Typo.body1" Class="mb-4" Color="Color.Secondary">
                @AgentDescription
            </MudText>
        }

        <div id="chatMessages" style="height:60vh; width:100%; overflow-y:auto;" class="mb-4">
            @if (messages is null)
            {
                <MudProgressCircular Indeterminate="true" />
            }
            else if (!messages.Any())
            {
                <MudChat ChatPosition="ChatBubblePosition.Start">
                    <MudChatBubble Avatar="@Icons.Material.Filled.SupportAgent">
                        No messages yet. Say hi!
                    </MudChatBubble>
                </MudChat>
            }
            else
            {
                @foreach (var m in messages)
                {
                    <MudChat UserName="@(m.Role == "user" ? "You" : "Agent")"
                             UserAvatar="@(m.Role == "user" ? Icons.Material.Filled.Person : Icons.Material.Filled.SupportAgent)"
                             ChatPosition="@(m.Role == "user" ? ChatBubblePosition.End : ChatBubblePosition.Start)">
                        <MudAvatar>@(m.Role == "user" ? "You" : StringHelper.GetInitials(AgentName))</MudAvatar>
                        <MudChatBubble Time="@m.Timestamp.ToLocalTime().ToString("g")" Class="mud-chatbubble">
                            @((MarkupString)StringHelper.ConvertMarkdownToHtml(@m.Content))
                        </MudChatBubble>
                    </MudChat>
                }
                @if (IsLoading)
                {
                    <MudChat ChatPosition="ChatBubblePosition.Start" UserName="Agent" UserAvatar="@Icons.Material.Filled.SupportAgent">
                        <MudAvatar>@StringHelper.GetInitials(AgentName)</MudAvatar>
                        <MudChatBubble>
                            <MudProgressCircular Indeterminate="true" Size="Size.Small" Class="me-2" />
                            <span>Agent is typing...</span>
                        </MudChatBubble>
                    </MudChat>
                }
            }
        </div>

        <MudStack Direction="Row" Spacing="1">
            <MudTextField @bind-Value="CurrentText"
                          Placeholder="Type a message..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Edit"
                          FullWidth="true"
                          OnKeyDown="OnInputKeyDown" />
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="SendAndRefreshHistory"
                       Disabled="@IsLoading">
                Send
            </MudButton>
        </MudStack>
    }
</MudPaper>
